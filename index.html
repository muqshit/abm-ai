<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ABM AI | Pro Max</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0b0b0c; color: #f1f5f9; overflow: hidden; }
        .glass-input { backdrop-filter: blur(24px); background: rgba(11, 11, 12, 0.85); }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        /* Animations */
        .recording { animation: pulse 1.5s infinite; color: #ef4444 !important; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.1); } }
        .slide-up { animation: slideUp 0.4s ease-out forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Components */
        .chat-action-btn { opacity: 0; transition: opacity 0.2s; }
        .chat-item:hover .chat-action-btn { opacity: 1; }
        .message-content img { max-width: 100%; border-radius: 12px; margin: 10px 0; border: 1px solid #334155; }
        pre { background: #1e1e1e !important; padding: 1.25rem; border-radius: 12px; margin: 1rem 0; overflow-x: auto; border: 1px solid #333; }
        code { font-family: 'Fira Code', monospace; font-size: 0.9em; }
    </style>
</head>
<body class="dark">

    <div id="app" class="flex h-screen w-full overflow-hidden">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-[60] w-72 bg-[#161618] border-r border-slate-800 transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col shadow-2xl">
            <div class="p-6 border-b border-slate-800/50">
                <div class="flex items-center gap-3 mb-6">
                    <img src="/logo.png" alt="Logo" class="w-10 h-10 rounded-xl border border-slate-700 bg-blue-600">
                    <span class="font-bold text-xl text-white tracking-tight">ABM AI</span>
                </div>
                <button onclick="createNewChat()" class="w-full py-3 bg-blue-600 text-white rounded-2xl font-semibold hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-600/20">
                    + New Chat
                </button>
            </div>
            
            <div id="chat-list" class="flex-1 overflow-y-auto px-4 py-4 space-y-2 custom-scroll">
                </div>

            <div class="p-4 border-t border-slate-800/50 mt-auto space-y-2">
                <button onclick="clearAllHistory()" class="flex items-center gap-3 w-full p-3 hover:bg-red-900/20 rounded-xl transition-all text-sm font-medium text-red-400 group">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="group-hover:scale-110"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg> 
                    Clear History
                </button>
            </div>
        </aside>

        <main class="relative flex-1 flex flex-col h-full w-full md:ml-72 bg-[#0b0b0c]">
            <header class="h-16 flex items-center justify-between px-6 border-b border-slate-800/50 z-40 bg-[#0b0b0c]/80 backdrop-blur-md">
                <button onclick="toggleSidebar()" class="md:hidden text-white p-2">â˜°</button>
                <div class="flex items-center gap-4">
                    <select id="quick-model-select" onchange="updateModelSetting(this.value)" class="bg-slate-800 text-xs font-bold px-4 py-2 rounded-full outline-none text-white cursor-pointer border border-slate-700 hover:border-blue-500 transition-all">
                        <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                        <option value="meta-llama/llama-3.1-8b-instruct:free">Llama 3.1 8B</option>
                    </select>
                </div>
                <div class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">ABM Engine v5.0</div>
            </header>

            <div id="chat-window" class="flex-1 overflow-y-auto p-4 md:p-10 space-y-8 custom-scroll scroll-smooth">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center space-y-4">
                    <div class="w-20 h-20 bg-blue-600 rounded-3xl flex items-center justify-center text-3xl mb-4 shadow-2xl">âš¡</div>
                    <h2 class="text-4xl font-bold text-white">How can I help?</h2>
                    <p class="text-slate-500 max-w-sm">Vision, Voice, and Speech-to-Text are all active.</p>
                </div>
            </div>

            <div class="relative z-50 glass-input border-t border-slate-800/50 p-4 md:p-6">
                <div class="max-w-4xl mx-auto">
                    <div id="image-preview-container" class="hidden mb-4 flex items-center gap-3 p-2 bg-slate-800/80 rounded-2xl w-fit border border-slate-700 slide-up">
                        <img id="image-preview" src="#" class="h-20 w-20 object-cover rounded-xl shadow-lg border border-slate-600">
                        <button onclick="clearImage()" class="text-slate-400 hover:text-red-400 p-2 text-2xl">&times;</button>
                    </div>

                    <div class="relative flex items-end gap-2 bg-[#1c1c1e] rounded-2xl border border-slate-700 p-2 shadow-2xl transition-all focus-within:border-blue-500/50">
                        <button onclick="document.getElementById('file-input').click()" class="p-3 text-slate-400 hover:text-blue-500 transition-colors">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                        </button>
                        <input type="file" id="file-input" class="hidden" accept="image/*" onchange="previewFile()">
                        
                        <button id="voice-btn" onclick="toggleVoice()" class="p-3 text-slate-400 hover:text-blue-500 transition-colors">
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>
                        </button>

                        <textarea id="user-input" rows="1" placeholder="Message ABM AI..." class="w-full p-3 bg-transparent text-white outline-none resize-none max-h-48 custom-scroll"></textarea>
                        
                        <button onclick="handleSend()" class="p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-500 transition-all active:scale-90 shadow-lg shadow-blue-600/20">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_KEY = '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';
        
        let state = {
            chats: JSON.parse(localStorage.getItem('abm_chats') || '[]'),
            currentChatId: null,
            settings: JSON.parse(localStorage.getItem('abm_app_settings') || JSON.stringify({ model: 'openai/gpt-4o-mini' })),
            isRecording: false,
            currentImageData: null
        };

        const win = document.getElementById('chat-window');
        const input = document.getElementById('user-input');

        // VOICE RECOGNITION (STT)
        const recognition = ('webkitSpeechRecognition' in window) ? new webkitSpeechRecognition() : null;
        if (recognition) {
            recognition.continuous = false;
            recognition.onresult = (e) => { 
                input.value += e.results[0][0].transcript;
                input.style.height = input.scrollHeight + 'px';
                toggleVoice(); 
            };
        }

        function toggleVoice() {
            if (!recognition) return alert("Speech recognition not supported.");
            state.isRecording = !state.isRecording;
            document.getElementById('voice-btn').classList.toggle('recording', state.isRecording);
            state.isRecording ? recognition.start() : recognition.stop();
        }

        // TEXT TO SPEECH (TTS)
        function speak(text) {
            window.speechSynthesis.cancel();
            const msg = new SpeechSynthesisUtterance(text.replace(/[#*`]/g, ''));
            msg.rate = 1.0;
            window.speechSynthesis.speak(msg);
        }

        // IMAGE HANDLING
        function previewFile() {
            const file = document.getElementById('file-input').files[0];
            const reader = new FileReader();
            reader.onloadend = () => {
                state.currentImageData = reader.result;
                document.getElementById('image-preview').src = reader.result;
                document.getElementById('image-preview-container').style.display = 'flex';
            };
            if (file) reader.readAsDataURL(file);
        }

        function clearImage() {
            state.currentImageData = null;
            document.getElementById('image-preview-container').style.display = 'none';
            document.getElementById('file-input').value = "";
        }

        // CORE LOGIC
        function updateModelSetting(val) {
            state.settings.model = val;
            localStorage.setItem('abm_app_settings', JSON.stringify(state.settings));
        }

        async function handleSend() {
            const text = input.value.trim();
            if (!text && !state.currentImageData) return;
            
            if (!state.currentChatId) createNewChat();
            const chat = state.chats.find(c => c.id === state.currentChatId);
            
            const userText = text || "Sent an image";
            const imgData = state.currentImageData;
            
            chat.messages.push({ role: 'user', content: text, image: imgData });
            if (chat.title === 'New Conversation') chat.title = text.substring(0, 25) || "Image Inquiry";

            appendMessageUI('user', userText, imgData);
            input.value = ''; input.style.height = 'auto';
            clearImage();
            renderChatList();
            saveState();

            // Simulate AI fetch (Replace with your actual fetch logic)
            const aiBubble = appendMessageUI('assistant', "AI is processing your request...");
            // ... (Add Fetch API logic here using API_KEY and state.settings.model)
        }

        function appendMessageUI(role, text, img = null) {
            document.getElementById('welcome-screen').style.display = 'none';
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} mb-6 slide-up`;
            
            const isAI = role === 'assistant';
            div.innerHTML = `
                <div class="max-w-[85%]">
                    <div class="p-4 rounded-2xl ${role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-[#1c1c1e] text-slate-200 border border-slate-800 rounded-tl-none shadow-xl'}">
                        ${img ? `<img src="${img}" class="rounded-xl mb-3 shadow-lg">` : ''}
                        <div class="text-sm leading-relaxed">${marked.parse(text)}</div>
                    </div>
                    ${isAI ? `<button onclick="speak(\`${text.replace(/`/g, '\\`')}\`)" class="mt-2 text-[10px] text-slate-500 hover:text-blue-500 font-bold uppercase tracking-wider flex items-center gap-1">ðŸ”Š Read Aloud</button>` : ''}
                </div>
            `;
            win.appendChild(div);
            win.scrollTop = win.scrollHeight;
            return div;
        }

        function renderChatList() {
            const list = document.getElementById('chat-list'); list.innerHTML = '';
            state.chats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `chat-item flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all ${isActive ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`;
                div.innerHTML = `
                    <span class="truncate text-sm font-medium flex-1" onclick="loadChat('${chat.id}')">${chat.title}</span>
                    <div class="chat-action-btn flex items-center gap-2">
                        <button onclick="renameChat('${chat.id}')" class="text-xs hover:text-white">âœŽ</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function renameChat(id) {
            const chat = state.chats.find(c => c.id === id);
            const newName = prompt("Rename chat:", chat.title);
            if (newName) { chat.title = newName; saveState(); renderChatList(); }
        }

        function clearAllHistory() {
            if (confirm("Delete ALL chat history?")) {
                localStorage.removeItem('abm_chats');
                state.chats = [];
                state.currentChatId = null;
                win.innerHTML = '';
                createNewChat();
            }
        }

        function createNewChat() {
            const id = Date.now().toString();
            state.chats.unshift({ id, title: 'New Conversation', messages: [] });
            state.currentChatId = id;
            saveState(); renderChatList();
            win.innerHTML = ''; 
        }

        function loadChat(id) {
            state.currentChatId = id;
            renderChatList();
            win.innerHTML = '';
            const chat = state.chats.find(c => c.id === id);
            chat.messages.forEach(m => appendMessageUI(m.role, m.content, m.image));
        }

        function saveState() { localStorage.setItem('abm_chats', JSON.stringify(state.chats)); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }

        // Init
        document.getElementById('quick-model-select').value = state.settings.model;
        renderChatList();
        if (state.chats.length > 0) loadChat(state.chats[0].id);
    </script>
</body>
</html>
    pill.innerText="Connected";
  } else {
    pill.className="text-[10px] font-bold uppercase tracking-widest px-2 py-1 rounded-full bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400";
    pill.innerText="No Key";
  }
}

// ---------------- CHAT FUNCTIONS ----------------
function createNewChat(){
  const chat={id:Date.now().toString(),title:'New Chat',messages:[]};
  state.chats.unshift(chat);
  saveState();
  loadChat(chat.id);
  document.getElementById('user-input').focus();
}

function loadChat(id){
  state.currentChatId=id;
  const chat=state.chats.find(c=>c.id===id);
  const container=document.getElementById('chat-window');
  container.innerHTML='';
  if(chat) chat.messages.forEach(msg=>appendMessageUI(msg.role,msg.content));
  renderChatList();
}

function appendMessageUI(role,content){
  const container=document.getElementById('chat-window');
  const div=document.createElement('div');
  div.className=`flex ${role==='user'?'justify-end':'justify-start'} animate-msg mb-6`;
  const inner=document.createElement('div');
  inner.className=`message-bubble ${role==='user'?'user-msg':'ai-msg'}`;
  inner.innerHTML=marked.parse(content);
  div.appendChild(inner);
  container.appendChild(div);
  container.scrollTop=container.scrollHeight;
  return inner;
}

// ---------------- TYPING ANIMATION ----------------
async function typeText(el,text,speed=15){
  el.innerHTML='';
  for(let i=0;i<text.length;i++){
    el.innerHTML=marked.parse(text.slice(0,i+1));
    el.parentElement.parentElement.scrollTop=el.parentElement.parentElement.scrollHeight;
    await new Promise(r=>setTimeout(r,speed));
  }
}

// ---------------- SEND MESSAGE ----------------
async function handleSend(){
  const input=document.getElementById('user-input');
  const btn=document.getElementById('send-btn');
  const text=input.value.trim();
  if(!text) return;
  if(!state.currentChatId) createNewChat();
  const chat=state.chats.find(c=>c.id===state.currentChatId);
  chat.messages.push({role:'user',content:text});
  if(chat.title==='New Chat') chat.title=text.substring(0,30)+'...';
  input.value=''; input.style.height='auto';
  appendMessageUI('user',text);
  btn.disabled=true;
  const aiBubble=appendMessageUI('assistant','');

  try{
    const res=await fetch("https://openrouter.ai/api/v1/chat/completions",{
      method:"POST",
      headers:{
        "Authorization":`Bearer ${HIDDEN_API_KEY}`,
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        model:state.settings.model,
        messages:[{role:"system",content:state.settings.systemPrompt},...chat.messages]
      })
    });
    const data=await res.json();
    const content=data.choices[0].message.content||'';
    chat.messages.push({role:'assistant',content:content});
    await typeText(aiBubble,content);
    saveState();
  }catch(e){
    aiBubble.innerHTML='<span class="text-red-500 font-bold">API Error: Check your key.</span>';
  }finally{
    btn.disabled=false;
    renderChatList();
  }
}

// ---------------- OTHER UI ----------------
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('-translate-x-full');}
function toggleDarkMode(){
  state.settings.darkMode=!state.settings.darkMode;
  document.documentElement.classList.toggle('dark');
  document.getElementById('dark-mode-icon').innerText=state.settings.darkMode?'â˜€ï¸':'ðŸŒ™';
  saveState();
}
function renderChatList(){
  const list=document.getElementById('chat-list'); list.innerHTML='';
  state.chats.forEach(chat=>{
    const isActive=chat.id===state.currentChatId;
    const div=document.createElement('div');
    div.className=`group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all ${isActive?'bg-blue-50 dark:bg-blue-900/20 text-blue-600':'hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500'}`;
    div.onclick=()=>loadChat(chat.id);
    div.innerHTML=`<div class="truncate text-sm font-medium pr-2">${chat.title}</div>
                   <button onclick="deleteChat(event,'${chat.id}')" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-500 text-xs">âœ•</button>`;
    list.appendChild(div);
  });
}
function deleteChat(e,id){e.stopPropagation();state.chats=state.chats.filter(c=>c.id!==id);if(state.currentChatId===id)loadChat(state.chats[0]?.id||null);saveState();renderChatList();}
function openSettings(){
  document.getElementById('model-input').value=state.settings.model;
  document.getElementById('system-prompt-input').value=state.settings.systemPrompt;
  document.getElementById('settings-modal').classList.remove('hidden');
}
function closeSettings(){document.getElementById('settings-modal').classList.add('hidden');}
function saveSettings(){
  state.settings.model=document.getElementById('model-input').value;
  state.settings.systemPrompt=document.getElementById('system-prompt-input').value;
  saveState(); closeSettings();
}
function saveState(){
  localStorage.setItem('abm_chats',JSON.stringify(state.chats));
  localStorage.setItem('abm_settings',JSON.stringify(state.settings));
}
window.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey&&document.activeElement.id==='user-input'){e.preventDefault();handleSend();}});
init();
</script>

</body>
</html>
